<!DOCTYPE html> 
<html>
    <head>
        <meta charset="utf-8">
        <title>Multiple Alternative Audio Tracks - Example</title>
        <link href="https://vjs.zencdn.net/7.0/video-js.min.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
        <script src="https://rawgit.com/Odusanya18/PCDN/master/client/js/peer.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }
            .info {
                background-color: #eee;
                border: thin solid #333;
                border-radius: 3px;
                padding: 0 5px;
                margin: 20px 0;
            }
        </style>
</head>
<body>
  <div style="float:left" > 
  <video id="video"
         class="video-js vjs-default-skin"
         height="300"
         width="600"
         controls>
    <source
       src="https://bitdash-a.akamaihd.net/content/sintel/hls/playlist.m3u8"
       type="application/x-mpegURL">
  </video>
</div>
  <div style="float:left"><canvas id="updating-chart" width="500" height="300"></canvas></div>
  <div style="float:left"><canvas id="hours" width="500" height="300"></canvas></div>
    <script src="https://vjs.zencdn.net/7.0/video.min.js"></script>
    <script src="https://rawgit.com/Odusanya18/PCDN/master/client/js/apiCDNP2P.js?v=7"></script>
    <script src="https://unpkg.com/@videojs/http-streaming@1.0.2/dist/videojs-http-streaming.min.js"></script>
    <script>
        apiCDNP2P({host:"peerserver-.herokuapp.com", port: "443", key: 'peerjs',debug:3});
    </script>


  <script>
    // initialize the player
    var player = videojs('video');
    player.ready(function(){
    /**
   * Creates and sends an XMLHttpRequest.
   * TODO - expose video.js core's XHR and use that instead
   *
   * @param options {string | object} if this argument is a string, it
   * is intrepreted as a URL and a simple GET request is
   * inititated. If it is an object, it should contain a `url`
   * property that indicates the URL to request and optionally a
   * `method` which is the type of HTTP request to send.
   * @param callback (optional) {function} a function to call when the
   * request completes. If the request was not successful, the first
   * argument will be falsey.
   * @return {object} the XMLHttpRequest that was initiated.
   */
   videojs.Hls.xhr = function(url_C, callback) {
    // return videojs.Hls.xhrCDN(url_C, callback);
    // console.log(url_C);
    try {
      var url = url_C;
      if (typeof url_C === 'object') {
        url = url_C.url;
      }
      
      console.log("Call url", url);
      var self = this;
      if (url.indexOf(".ts") < 0){
        if (!myBaseUrl[url]){
          myBaseUrl[url] = {};//responseType:"arraybuffer"
        }
        return videojs.Hls.xhrCDN(url, callback);
      }else {
        if (!myBaseUrl[url]){
          myBaseUrl[url] = {};
        }
        if (Object.keys(myBaseUrl[url]).length > 0){
          // have leacher
          videojs.Hls.xhrP2P(Object.keys(myBaseUrl[url]), url, callback);
          console.log("I know leechers");
          // update leachers
          videojs.APIP2P.updateLeechers(url, function (leechers){});
          return {
            abort:function(){
              console.log("========================================================================");
            }
          };
        }
      }
      if (typeof callback !== 'function') {
        callback = function() {};
      }
      // videojs.Hls.xhrCDN(url, callback);

      console.log("Want leechers");
      videojs.APIP2P.updateLeechers(url, function (leechers){
        if (leechers.length){
          videojs.Hls.xhrP2P(leechers, url, callback);
        }else{
          videojs.Hls.xhrCDN(url, callback);
        }
      });
      return {
        abort:function(){
          console.log("========================================================================");
        }
      };
    }catch (e){
      console.log(e);
    }
    return {
      abort:function(){
        console.log("========================================================================");
      }
    };
   };
    });

    var canvas = document.getElementById('updating-chart'),
    ctx = canvas.getContext('2d'),
    startingData = {
      labels: [0],
      datasets: [
          {
              fillColor: "rgba(220,0,0,0.2)",
              strokeColor: "rgba(220,220,220,1)",
              pointColor: "rgba(220,220,220,1)",
              pointStrokeColor: "#fff",
              data: [0],
              label:"CDN"
          },
          {
              fillColor: "rgba(0,187,0,0.2)",
              strokeColor: "rgba(0,187,0,1)",
              pointColor: "rgba(0,187,0,1)",
              pointStrokeColor: "#fff",
              data: [0],
              label:"P2P"
          }
      ]
    };

    var data = [
    
    {
        value : 1,
        color : "#2c9c69",
        label:"P2P"
    },
    
    {
        value : 1,
        color : "#c62f29",
        label : "CDN"
    }

];
var canvas = document.getElementById("hours");
var ctxpie = canvas.getContext("2d");
var pie = new Chart(ctxpie, {
    type: 'doughnut',
    data: data,
    options: {animationSteps: 1}
});
      
    
  // Reduce the animation steps for demo clarity.
      
  var myLiveChart = new Chart(ctx, {
    type: 'line',
    data: startingData,
    options: {animationSteps: 15}
});
  var numbers = 10;
  for (var i = 0; i < numbers; i++) {
    addData(myLiveChart, [0, 0], i);
  }
  removeData(myLiveChart);
  latestLabel = startingData.labels[numbers-1];

  setInterval(function(){
    // Add two random numbers for each dataset

    addData(myLiveChart, [(statP2P.cdn/1024/1024).toFixed(2), (statP2P.p2p/1024/1024).toFixed(2)], ++latestLabel);
    // Remove the first point so we dont just add values forever
    removeData(myLiveChart);
    data[1].value = Math.floor(statP2P.cdn/1024);
    data[0].value = Math.floor(statP2P.p2p/1024);
    pie.update();
  }, 5*1000);

    function addData(chart, data, label) {
        chart.data.labels.push(label);
        chart.data.datasets.forEach(function(dataset){
            dataset.data.push(data);
        });
        chart.update();
    }

    function removeData(chart) {
        chart.data.labels.pop();
        chart.data.datasets.forEach(function(dataset){
            dataset.data.pop();
        });
        chart.update();
    }
  </script>
</body>
</html>
